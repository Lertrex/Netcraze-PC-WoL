# Netcraze-PC-WoL
Репозиторий содержает инструкцию об удалённом включении и выключении ПК через голосое управление с Алисой и приложение "Умный дом"


РАБОТАЕТ ТОЛЬКО С БЕЛЫМ IP (IP вашего роутера совпадает с ip на сайте 2ip.ru (ip роутера можно найти в "админке" роутера, в подключении "Ethernet" снизу будет написан Ip-адрес)) и МАТЕРИНКАМИ, ПОДДЕРЖИВАЮЩИМИ Wake on LAN.
Найдите в интернете как включить WoL на вашей материнке, пример для msi https://ru.msi.com/support/technical_details/MB_Wake_On_LAN и проделайте все необходимые действия. После протестируйте работу, выключив ПК и попытайтесь его включить через приложение NetCraze (https://support.keenetic.ru/lite/kn-1311/ru/31750-waking-up-a-computer-with-wol-from-the-mobile-app.html). Если работает - продолжайте дальше
1. Откройте в браузере 192.168.1.1, войдите в учётную запись, перейдите в параметры системы
2. Нажмите Изменить набор компонентов и поставьте галочку напротив: 1. Сервер SSH 2. Файловая система Ext 3. Поддержка открытых пакетов 4. Общий доступ к файлам и принтерам по протоколу SMB
3. Отформатируйте флешку по Linux ext4, задайте флешке имя через Paragon Hard Disk Manager 17 Advanced (https://s3.fixti.ru/files/load2/075/Paragon%20Hard%20Disk%20Manager%2017%20Advanced%2017.20.17%20Rus%20by%20AlexYar%20Portable.rar)
4. Вставьте флешку в роутер
5. Откройте раздел "Приложения" и включите SMB сервер, добавив общий ресурс (ваша флешка), уберите галочку с анонимного доступа и дайте пользователю admin все права.
6. На ПК нажмите win+R и введите \\\\192.168.1.1
7. Откройте флешку, создайте папку install и переместите туда файл с entware
(Файл брать тут https://help.keenetic.com/hc/ru/articles/360021214160-%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D1%8B-%D0%BF%D0%B0%D0%BA%D0%B5%D1%82%D0%BE%D0%B2-%D1%80%D0%B5%D0%BF%D0%BE%D0%B7%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D1%8F-Entware-%D0%BD%D0%B0-USB-%D0%BD%D0%B0%D0%BA%D0%BE%D0%BF%D0%B8%D1%82%D0%B5%D0%BB%D1%8C, обязательно сверить модель роутера)
8. Перейдите в раздел OPKG в "админке" роутера, выберите накопитель, поставьте галочку напротив
пользователя администратора, чтобы дать доступ и нажмите  Сохранить.
9. Перейдите в раздел диагностика, нажмите на "Показать журнал" (Если не включено "Обновлять в реальном времени", то включите, перезагрузите страницу и ещё раз просматривайте журнал) и ожидайте вывода строки "installer: [5/5] Установка системы пакетов "Entware" завершена! Не забудьте сменить пароль и номер порта!" (Если вылезла ошибка, значит вы скачали не тот пакет, необходимо заново отформатировать флешку и повторить действия заново, но уже с "правильным" пакетом.
10. Перейдите в раздел "Пользователи и доступ", в службах управления поменяйте порт управления по SSH на 222. После перейдите в раздел "Переадресация портов", добавьте правило с протоколом TCP/UDP, откройте и перенаправляйте на порт 9090, выход поставьте на ваш ПК. Создайте ещё одно правило с протоколом TCP, откройте и перенаправляйте на порт 8080, выход поставьте на "Это устройство Netcraze". Включите правила.
11. Скачайте PuTTy на ваш ПК (http://www.putty.org/). Введите в Host Name 192.168.1.1, в порт 222, выберите тип подключения SSH и нажмите снизу Open.
12. Введите имя пользователя root (Чтобы вставить текст в окне консоли нажмите ПКМ)
13. Введите пароль keenetic (При вводе пароля он не будет отображаться, это нормально)
14. Если хотите, можете сменить пароль от пользователя root командой passwd.
15. Введите ```opkg update```
16. Введите ```opkg install etherwake```
17. Введите ```opkg install socat```
18. Введите ```cat > /opt/bin/pc-api.sh << 'EOF'```
19. В коде ниже, поменяйте значения переменных SECRET_KEY (Придумайте сами 60 символов), PC_MAC (мак адрес ПК, можно получить в "админке" роутера. Перейдите в список клиентов и найдите там свой ПК, после чего скопируйте MAC), PC_IP (ваш ip через 2ip.ru). После замены переменных скопируйте и вставьте код:
```
#!/bin/sh
read -r line
line=$(echo "$line" | tr -d '\r')
while read -t 1 h; do [ -z "$h" ] && break; done

case "$line" in
    GET\ */*)
        url=${line#GET }
        url=${url%% *}
        query=${url#*\?}
        ;;
    *)
        query=""
        ;;
esac

action=$(echo "$query" | awk -F'[&=]' '{for(i=1;i<=NF;i+=2) if($i=="action") print $(i+1)}')
key=$(echo "$query" | awk -F'[&=]' '{for(i=1;i<=NF;i+=2) if($i=="key") print $(i+1)}')

SECRET_KEY="YOUR_KEY"
PC_MAC="YOUR_PC_MAC"
PC_IP="YOUR_PC_IP"
STATUS_PORT=9090

if [ "$key" != "$SECRET_KEY" ]; then
    echo "HTTP/1.1 403 Forbidden"
    echo "Content-Type: application/json"
    echo "Connection: close"
    echo ""
    echo '{"error":"Invalid key"}'
    exit 0
fi

wol() {
    mac_clean=$(echo "$PC_MAC" | tr -d ':.-' | tr '[:upper:]' '[:lower:]')
    
    broadcast="192.168.1.255"

    packet="ffffffffffff"
    i=0
    while [ $i -lt 16 ]; do
        packet="$packet$mac_clean"
        i=$((i + 1))
    done

    echo "$packet" | xxd -r -p | socat - UDP-DATAGRAM:"$broadcast":9,broadcast
}

check_status() {
    (
        echo -e "GET / HTTP/1.0\r\n\r\n" | nc "$PC_IP" "$STATUS_PORT" > /dev/null 2>&1
        echo "$?" > /tmp/nc_exit
    ) &
    pid=$!
    sleep 3
    kill $pid 2>/dev/null && echo "1" > /tmp/nc_exit
    wait $pid 2>/dev/null

    if [ "$(cat /tmp/nc_exit 2>/dev/null)" = "0" ]; then
        echo "true"
    else
        echo "false"
    fi
    rm -f /tmp/nc_exit
}

echo "HTTP/1.1 200 OK"
echo "Content-Type: application/json"
echo "Connection: close"
echo ""

case "$action" in
    on)
        wol
        echo '{"status":"success","message":"PC turning on"}'
        ;;
    status)
        s=$(check_status)
        echo "{\"status\":$s}"
        ;;
    *)
        echo '{"error":"Use action=on|status"}'
        ;;
esac
```
20. Введите ```EOF```
21. Не закрывайте консоль! Установите на ПК nodejs (https://nodejs.org/en/download) через msi.
22. Скачайте и измените скрипт AlisaShutdownPC -> NJSI_Data -> app -> index.js (https://disk.yandex.ru/d/wVxf5mw3bCdsFQ) в переменную SECRET_KEY введите ваш ранее введённый ключ, сохраните, откройте cmd, перейдите в папку AlisaShutdownPC -> NJSI_Data -> app через cmd и введите команды: 1. ```npm install -g pkg``` 2. ```pkg index.js```
23. Скачайте nssm (https://www.nssm.cc/release/nssm-2.24.zip), распакуйте архив на диск C, найдите файл в папках win32 и win64 и выберите один в зависимости от вашей системы
24. Запустите cmd от имени администратора, введите полный путь до exe файла nssm, введите install PControl и путь до исполняемого файла Алисы (сгенерированный вами в п. 22 (название - index-win.exe)). Пример: ```C:\Tools\nssm-2.24\win64\nssm.exe install PControl C:\Tools\AlisaShutdownPC\NJSI_Data\app\index-win.exe```
25. Запустите службу ```net start PControl```
26. Введите в косноли PuTTy ```chmod +x /opt/bin/pc-api.sh```
27. Введите ```killall socat 2>/dev/null```
28. Введите ```socat TCP-LISTEN:8080,reuseaddr,fork EXEC:/opt/bin/pc-api.sh```
29. Проверьте работоспособность, перейдя в браузере на сайт http://ВАШ_ИП:8080/?action=status&key=ВАШ_КЛЮЧ (сайт потупит секунды 2 и должен дать ответ в формате json).
30. Откройте сайт alexstar.ru, войдите через яндекс, Добавьте три правила HTTP (GET)
31. Введите имя правила Включи компьютер, в url введите http://ВАШ_ИП:8080/?action=on&key=ВАШ_КЛЮЧ
32. Включите "Ждать ответ от сервера", "Проверять SSL сертификат сервера", "Правило включено".
33. В другом правиле введите имя правила Выключи компьютер, в url введите http://ВАШ_ИП:9090/shutdown?key=ВАШ_КЛЮЧ
34. Включите "Проверять SSL сертификат сервера", "Правило включено"
35. В следующем правиле введите имя правила Статус компьютера, в url введите http://ВАШ_ИП:8080/?action=status&key=ВАШ_КЛЮЧ
36. Включите "Ждать ответ от сервера", "Проверять SSL сертификат сервера", "Правило включено".
37. Нажмите на "Виртуальные устройства умного дома", создайте устройство выключатель, назовите его "Компьютер", введите "Место расположения", как в приложении умного дома", установите Правило на включение - Включи компьютер GET, Правило на выключение - Выключи компьютер GET, Запрос состояния вкл выкл - Статус компьютера GET.
38. На ПК нажмите win+R и введите \\\\192.168.1.1
39. Перейдите в папку Имя_вашей_флешки\\etc\\init.d
40. Создайте файл "S80findPl"
41. Откройте файл и впишите туда код:
```
#!/bin/sh

ENABLED=yes
PROCS=socat
ARGS="TCP-LISTEN:8080,reuseaddr,fork EXEC:/opt/bin/pc-api.sh"
DESC="pc-api via socat"
PATH=/opt/sbin:/opt/bin:/opt/usr/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

. /opt/etc/init.d/rc.func
```
42. Сохраните файл
43. В приложении "Умный дом", добавьте устройство умного дома, введите в поиск "Домовёнок Кузя", соедините профиль, у вас появится выключатель "Компьютер", пользуйтесь (если не появился, обновите список устройтв или проверьте существование устройства на сайте alexstar.ru) :)  
